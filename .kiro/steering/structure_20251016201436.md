---
inclusion: always
---

# Project Structure

## Root Directory

```
.
├── main.bicep              # Infrastructure as Code (Bicep template)
├── deploy.sh               # Deployment automation script
├── .env                    # Environment configuration (gitignored)
├── .env.example            # Example configuration template
│
├── Ping/                   # Azure Function app
│   ├── __init__.py         # Function handler (HTTP trigger)
│   └── function.json       # Function binding configuration
│
├── heartbeat_agent.py      # Monitoring agent (runs on client device)
├── start_heartbeat.sh      # Start agent in tmux session
├── stop_heartbeat.sh       # Stop agent
│
├── host.json               # Function app host configuration
├── requirements.txt        # Python dependencies (pinned versions)
│
├── README.md               # Main documentation
├── AGENT_README.md         # Agent-specific documentation
├── ALERT_TROUBLESHOOTING.md # Alert debugging guide
└── SECURITY.md             # Security documentation
```

## Key Files

### Infrastructure (`main.bicep`)
- Defines all Azure resources
- Uses Managed Identity for secure storage access
- Configures alert rules with 5-minute evaluation window
- Action Groups must use `location='global'`

### Function App (`Ping/`)
- HTTP trigger on `/api/ping` route
- Accepts GET/POST with anonymous auth
- Validates and sanitizes input (device name, note, IP)
- Logs structured JSON to Application Insights
- Max field lengths: device=100 chars, note=500 chars

### Heartbeat Agent (`heartbeat_agent.py`)
- Standalone Python script with zero dependencies
- Supports CLI args and environment variables
- Daemon mode for continuous operation
- Tracks consecutive failures (warns after 5)
- SSL certificate verification enabled

### Deployment (`deploy.sh`)
- Sources `.env` for configuration
- Creates resource group if needed
- Deploys Bicep template
- Packages and deploys function code via OneDeploy API
- Tests endpoint after deployment

## Configuration Files

### `.env` (gitignored)
Required variables:
- `RG` - Resource group name
- `LOCATION` - Azure region
- `ALERT_EMAIL` - Email for alerts
- `HEARTBEAT_URL` - Function endpoint URL
- `HEARTBEAT_DEVICE` - Device identifier
- `HEARTBEAT_INTERVAL` - Ping interval in seconds

### `host.json`
Minimal Azure Functions host configuration (v2.0)

### `requirements.txt`
Pinned dependencies for reproducibility and security

## Naming Conventions

- Resource names use prefix pattern: `{prefix}-{type}`
- Storage accounts: `{prefix}sa{uniqueString}` (lowercase, no hyphens)
- Function apps: `{prefix}-func` (lowercase)
- Alert rules: `{prefix}-heartbeat-miss`
- Action groups: `{prefix}-ag`

## File Organization Rules

- Infrastructure code in root (`main.bicep`)
- Function code in `Ping/` directory
- Agent scripts in root (for easy access)
- Documentation in root (README files)
- History/temp files in `.history/` (gitignored)
- Virtual environment in `.venv/` (gitignored)
