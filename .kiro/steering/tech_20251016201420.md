---
inclusion: always
---

# Technology Stack

## Infrastructure

- **Cloud Platform**: Azure
- **IaC**: Bicep templates (`main.bicep`)
- **Deployment**: Bash scripts with Azure CLI

## Azure Services

- **Azure Functions** - Python 3.11 on Linux Consumption Plan (Y1 SKU)
- **Application Insights** - Logging and monitoring
- **Azure Monitor** - Scheduled query alerts
- **Storage Account** - Function app storage (Standard_LRS)
- **Managed Identity** - Secure storage access (no connection strings)

## Application Stack

- **Runtime**: Python 3.11 (Azure Functions v4)
- **Dependencies**: `azure-functions==1.20.0` (pinned for security)
- **Agent**: Pure Python 3.8+ with zero external dependencies (uses stdlib only)

## Development Tools

- **tmux** - Background process management for heartbeat agent
- **Azure CLI** - Deployment and management
- **jq** - JSON parsing in deployment scripts

## Common Commands

### Deployment
```bash
# Full deployment (infrastructure + code)
./deploy.sh

# Infrastructure only
az deployment group create -g $RG -f main.bicep -p prefix=$PREFIX alertEmail=$ALERT_EMAIL

# View function logs
az webapp log tail --name $FUNC_APP_NAME --resource-group $RG
```

### Local Development
```bash
# Create virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Start local function runtime
func start

# Test locally
curl http://localhost:7071/api/ping
```

### Agent Management
```bash
# Start agent in background (tmux)
./start_heartbeat.sh

# Check agent status
tmux capture-pane -pt isp-monitor -S -50

# Stop agent
./stop_heartbeat.sh

# Manual test
python3 heartbeat_agent.py --url <URL> --device <NAME> --once
```

### Monitoring
```bash
# Query Application Insights
az monitor app-insights query --app <app-name> --resource-group $RG \
  --analytics-query "requests | where name == 'Ping' | where timestamp > ago(1h)"

# Check alert rules
az monitor scheduled-query list --resource-group $RG --output table
```

## Security Practices

- HTTPS only (enforced)
- TLS 1.2 minimum
- Managed Identity for storage access (no connection strings)
- Input sanitization in function code
- Anonymous auth level (consider changing to `function` for production)
