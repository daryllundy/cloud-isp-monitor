# Design Document

## Overview

This design addresses the alert notification issues identified in the Azure ISP Monitor system. The root cause analysis revealed that the alert rule is technically functioning correctly, but two configuration parameters are preventing users from receiving timely and complete notifications:

1. **Mute Actions Duration (PT5M)**: Suppresses notifications for 5 minutes after the initial alert, meaning only one email is sent during extended outages
2. **Auto Mitigate (false)**: Prevents the alert from automatically resolving when connectivity is restored, requiring manual intervention

The solution involves modifying the Bicep template to correct these settings, enhancing the deployment script to verify the changes, and updating documentation to help users validate email delivery.

## Architecture

### Current Alert Flow (Problematic)

```
Heartbeat Stops (02:10)
    ↓
Alert Evaluates (02:15) → Condition Met (count < 1)
    ↓
Alert Fires → Email Sent ✅
    ↓
Mute Actions Enabled (5 minutes)
    ↓
Alert Evaluates (02:20) → Still Firing → Email Suppressed ❌
    ↓
Alert Evaluates (02:25) → Still Firing → Email Suppressed ❌
    ↓
... (continues for duration of outage)
    ↓
Heartbeat Resumes (02:53)
    ↓
Alert Evaluates (02:55) → Condition Not Met
    ↓
Alert Remains in Fired State (autoMitigate: false) ❌
```

### Proposed Alert Flow (Fixed)

```
Heartbeat Stops (02:10)
    ↓
Alert Evaluates (02:15) → Condition Met (count < 1)
    ↓
Alert Fires → Email Sent ✅
    ↓
Mute Actions Disabled (PT0M)
    ↓
Alert Evaluates (02:20) → Still Firing → Email Sent ✅
    ↓
Alert Evaluates (02:25) → Still Firing → Email Sent ✅
    ↓
... (continues for duration of outage)
    ↓
Heartbeat Resumes (02:53)
    ↓
Alert Evaluates (02:55) → Condition Not Met
    ↓
Alert Auto-Resolves → Resolution Email Sent ✅
```

## Components and Interfaces

### 1. Bicep Template (main.bicep)

**Current Configuration (Lines 164-165):**
```bicep
muteActionsDuration: 'PT5M'
autoMitigate: false
```

**Modified Configuration:**
```bicep
muteActionsDuration: 'PT0M'
autoMitigate: true
```

**Impact:**
- `muteActionsDuration: 'PT0M'` enables notifications every 5 minutes during outages (evaluation frequency)
- `autoMitigate: true` allows the alert to automatically resolve when pings resume

**Resource:** `Microsoft.Insights/scheduledQueryRules@2023-12-01`

### 2. Deployment Script (deploy.sh)

**Current Behavior:**
- Deploys infrastructure
- Deploys function code
- Tests endpoint
- No verification of alert configuration

**Enhanced Behavior:**
- Deploys infrastructure with updated alert settings
- Verifies alert configuration post-deployment
- Displays action group configuration for user validation
- Provides clear success/failure messages

**New Verification Section:**
```bash
# Verify alert configuration
echo "Verifying alert configuration..."
ALERT_CONFIG=$(az monitor scheduled-query show \
  --name "${PREFIX}-heartbeat-miss" \
  --resource-group "$RG" \
  --query "{muteActions:muteActionsDuration, autoMitigate:autoMitigate}" \
  --output json)

MUTE_DURATION=$(echo "$ALERT_CONFIG" | jq -r '.muteActions')
AUTO_MITIGATE=$(echo "$ALERT_CONFIG" | jq -r '.autoMitigate')

if [ "$MUTE_DURATION" = "PT0M" ] && [ "$AUTO_MITIGATE" = "true" ]; then
  echo "✓ Alert configuration verified"
else
  echo "⚠ Alert configuration mismatch:"
  echo "  Mute Duration: $MUTE_DURATION (expected: PT0M)"
  echo "  Auto Mitigate: $AUTO_MITIGATE (expected: true)"
fi

# Display action group configuration
echo "Action Group Configuration:"
az monitor action-group show \
  --name "${PREFIX}-ag" \
  --resource-group "$RG" \
  --query "{name:name, enabled:enabled, email:emailReceivers[0].emailAddress, status:emailReceivers[0].status}" \
  --output table
```

### 3. Documentation Updates

**Files to Update:**
- `README.md` - Add section on alert configuration and testing
- `ALERT_TROUBLESHOOTING.md` - Update with resolution status and mark as resolved

**New Documentation Sections:**

#### Alert Configuration
Explains the alert settings and their impact on notification behavior.

#### Testing Alert Notifications
Step-by-step guide to manually trigger an alert and verify email delivery:
1. Stop heartbeat agent
2. Wait 6-7 minutes
3. Check email (including spam)
4. Verify alert fired using Azure CLI
5. Resume heartbeat
6. Verify alert resolved

#### Email Delivery Checklist
- Check spam/junk folders
- Verify Azure email addresses in safe senders
- Confirm action group email address
- Check Gmail tabs (Promotions, Updates)

## Data Models

### Alert Rule Configuration

```typescript
interface AlertRuleConfig {
  name: string;                    // e.g., "darylhome-heartbeat-miss"
  enabled: boolean;                // true
  evaluationFrequency: string;     // "PT5M" (5 minutes)
  windowSize: string;              // "PT5M" (5 minutes)
  severity: number;                // 2 (Warning)
  muteActionsDuration: string;     // "PT0M" (changed from "PT5M")
  autoMitigate: boolean;           // true (changed from false)
  query: string;                   // KQL query
  threshold: number;               // 1
  operator: string;                // "LessThan"
}
```

### Action Group Configuration

```typescript
interface ActionGroupConfig {
  name: string;                    // e.g., "darylhome-ag"
  location: string;                // "global" (required)
  enabled: boolean;                // true
  emailReceivers: EmailReceiver[];
}

interface EmailReceiver {
  name: string;                    // "primary"
  emailAddress: string;            // User's email
  useCommonAlertSchema: boolean;   // true
  status: string;                  // "Enabled" | "NotSpecified"
}
```

## Error Handling

### Deployment Failures

**Scenario 1: Bicep Deployment Fails**
- **Detection**: `az deployment group create` returns non-zero exit code
- **Handling**: Script exits with error message, no function code deployment attempted
- **User Action**: Check Azure portal for deployment errors, verify parameters

**Scenario 2: Alert Configuration Verification Fails**
- **Detection**: Post-deployment verification shows incorrect values
- **Handling**: Display warning with actual vs. expected values
- **User Action**: Re-run deployment or manually update alert rule in portal

**Scenario 3: Action Group Not Enabled**
- **Detection**: Action group status check shows disabled or email not confirmed
- **Handling**: Display warning with action group details
- **User Action**: Check email for confirmation link, verify email address

### Email Delivery Issues

**Scenario 1: Emails Going to Spam**
- **Detection**: User reports not receiving emails, alert history shows fired
- **Handling**: Documentation provides spam folder check instructions
- **User Action**: Add Azure email addresses to safe senders list

**Scenario 2: Email Not Confirmed**
- **Detection**: Action group email receiver status is "NotSpecified"
- **Handling**: Deployment script displays email receiver status
- **User Action**: Check inbox for confirmation email from Azure, click confirmation link

**Scenario 3: Wrong Email Address**
- **Detection**: User receives no emails, action group shows different address
- **Handling**: Deployment script displays configured email address
- **User Action**: Update ALERT_EMAIL in .env file, re-deploy

## Testing Strategy

### Unit Testing

Not applicable - this is an infrastructure configuration change with no application code modifications.

### Integration Testing

**Test 1: Alert Firing Test**
- **Objective**: Verify alert fires when heartbeat stops
- **Steps**:
  1. Deploy updated infrastructure
  2. Stop heartbeat agent: `./stop_heartbeat.sh`
  3. Wait 6-7 minutes (longer than evaluation window)
  4. Verify alert fired: Query Application Insights for zero pings
  5. Check email inbox (including spam)
- **Expected Result**: Email received within 7 minutes of stopping heartbeat

**Test 2: Continuous Notification Test**
- **Objective**: Verify multiple emails sent during extended outage
- **Steps**:
  1. Stop heartbeat agent
  2. Wait 15 minutes
  3. Count emails received
- **Expected Result**: Minimum 2 emails received (at 5 min and 10 min marks)

**Test 3: Auto-Resolution Test**
- **Objective**: Verify alert resolves automatically when heartbeat resumes
- **Steps**:
  1. Stop heartbeat agent
  2. Wait for alert to fire (6-7 minutes)
  3. Resume heartbeat: `./start_heartbeat.sh`
  4. Wait 6-7 minutes
  5. Check for resolution email
- **Expected Result**: Resolution email received within 7 minutes of resuming heartbeat

**Test 4: Configuration Verification Test**
- **Objective**: Verify deployment script correctly validates alert settings
- **Steps**:
  1. Run deployment script
  2. Review verification output
- **Expected Result**: Script displays "✓ Alert configuration verified"

### Manual Testing Checklist

```bash
# 1. Deploy infrastructure
./deploy.sh

# 2. Verify alert configuration
az monitor scheduled-query show \
  --name darylhome-heartbeat-miss \
  --resource-group darylhome-rg \
  --query "{muteActions:muteActionsDuration, autoMitigate:autoMitigate}" \
  --output table

# Expected: muteActions=PT0M, autoMitigate=true

# 3. Verify action group
az monitor action-group show \
  --name darylhome-ag \
  --resource-group darylhome-rg \
  --query "{enabled:enabled, email:emailReceivers[0].emailAddress}" \
  --output table

# Expected: enabled=true, email=<your-email>

# 4. Test alert firing
./stop_heartbeat.sh
# Wait 7 minutes, check email

# 5. Test alert resolution
./start_heartbeat.sh
# Wait 7 minutes, check for resolution email
```

## Implementation Considerations

### Backward Compatibility

**Impact**: None. This is a configuration change that improves functionality without breaking existing behavior.

**Migration**: Existing deployments will be updated when users run `./deploy.sh` with the modified Bicep template.

### Performance Impact

**Alert Evaluation**: No change - still evaluates every 5 minutes

**Email Volume**: Increased during outages
- **Before**: 1 email per outage (regardless of duration)
- **After**: 1 email every 5 minutes during outage
- **Example**: 30-minute outage = 6 emails (vs. 1 previously)

**Cost Impact**: Negligible - Azure Monitor email notifications are included in the service

### Security Considerations

**Email Exposure**: Alert emails contain:
- Device name (user-provided)
- Timestamp
- Alert rule name
- Resource group name

**Recommendation**: Users should ensure their email account is secure and consider using a dedicated monitoring email address.

### Rollback Plan

If the changes cause issues, users can revert by:

1. **Option 1: Git Revert**
   ```bash
   git revert <commit-hash>
   ./deploy.sh
   ```

2. **Option 2: Manual Bicep Edit**
   ```bicep
   muteActionsDuration: 'PT5M'  // Restore 5-minute mute
   autoMitigate: false          // Disable auto-resolution
   ```
   Then run `./deploy.sh`

3. **Option 3: Azure Portal**
   - Navigate to Alert Rule
   - Edit settings manually
   - Save changes

## Dependencies

### External Dependencies

- **Azure CLI**: Required for deployment and verification commands
- **jq**: Required for JSON parsing in deployment script
- **curl**: Required for endpoint testing

### Azure Resources

- **Application Insights**: Must be deployed and receiving heartbeat data
- **Action Group**: Must have valid email address configured
- **Alert Rule**: Must reference correct Application Insights resource

### Configuration Files

- **.env**: Must contain ALERT_EMAIL, RG, LOCATION
- **main.bicep**: Must be updated with new alert settings

## Deployment Process

### Pre-Deployment Checklist

- [ ] Backup current .env file
- [ ] Verify ALERT_EMAIL is correct in .env
- [ ] Ensure Azure CLI is logged in: `az account show`
- [ ] Verify jq is installed: `which jq`
- [ ] Review current alert configuration (optional)

### Deployment Steps

1. **Update Bicep Template**
   - Modify lines 164-165 in main.bicep
   - Commit changes to version control

2. **Run Deployment Script**
   ```bash
   ./deploy.sh
   ```

3. **Verify Deployment**
   - Check script output for "✓ Alert configuration verified"
   - Review action group configuration display
   - Confirm no error messages

4. **Test Alert System**
   - Follow manual testing checklist
   - Verify email delivery

### Post-Deployment Validation

```bash
# Verify alert settings
az monitor scheduled-query show \
  --name ${PREFIX}-heartbeat-miss \
  --resource-group $RG \
  --query "{mute:muteActionsDuration, auto:autoMitigate, enabled:enabled}" \
  --output table

# Check recent alert activity
az monitor activity-log list \
  --resource-group $RG \
  --max-events 20 \
  --query "[?contains(operationName.value, 'Alert')]" \
  --output table
```

## Documentation Updates

### README.md Additions

**New Section: Alert Configuration**
```markdown
## Alert Configuration

The alert system is configured to:
- Evaluate every 5 minutes for missing heartbeat pings
- Send email notifications immediately when connectivity is lost
- Send additional emails every 5 minutes while the outage persists
- Automatically resolve and send a resolution email when connectivity is restored

### Testing Alerts

To test the alert system:

1. Stop the heartbeat agent:
   ```bash
   ./stop_heartbeat.sh
   ```

2. Wait 6-7 minutes for the alert to fire

3. Check your email (including spam folder) for alert notification

4. Resume the heartbeat agent:
   ```bash
   ./start_heartbeat.sh
   ```

5. Wait 6-7 minutes for the resolution email

### Email Delivery Troubleshooting

If you don't receive alert emails:

- Check your spam/junk folder for emails from `azure-noreply@microsoft.com`
- Verify your email address in `.env` matches the action group configuration
- Check for a confirmation email from Azure when first setting up the action group
- Add Azure email addresses to your safe senders list
```

### ALERT_TROUBLESHOOTING.md Updates

Add resolution section at the top:

```markdown
## Resolution Status

**Status:** ✅ RESOLVED

**Date:** 2025-10-17

**Fix Applied:**
- Updated `muteActionsDuration` from `PT5M` to `PT0M` in main.bicep
- Enabled `autoMitigate: true` in main.bicep
- Enhanced deployment script with configuration verification
- Updated documentation with testing procedures

**Verification:**
Run `./deploy.sh` to apply the fix, then test using the procedure in README.md.

---

[Original troubleshooting content follows...]
```
