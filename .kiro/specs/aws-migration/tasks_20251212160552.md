# Implementation Plan

- [x] 1. Set up AWS CDK project structure
  - Install AWS CDK CLI globally (`npm install -g aws-cdk`)
  - Create `cdk/` directory for infrastructure code
  - Initialize CDK app with Python (`cdk init app --language python`)
  - Create `.env.example` with AWS-specific variables (AWS_REGION, ALERT_EMAIL, PREFIX)
  - Update `.gitignore` to exclude CDK build artifacts (`cdk.out/`, `*.egg-info/`)
  - _Requirements: 1.1, 8.2_

- [x] 2. Implement Lambda function for heartbeat endpoint
  - [x] 2.1 Create Lambda function directory structure
    - Create `lambda/` directory for function code
    - Create `lambda/handler.py` for main function logic
    - Create `lambda/requirements.txt` (empty - no dependencies)
    - _Requirements: 1.2, 2.1_

  - [x] 2.2 Implement input validation and sanitization functions
    - Write `sanitize_string()` function with control character removal and length limits
    - Write `validate_ip()` function for IPv4/IPv6 validation
    - Handle empty/null inputs with defaults
    - _Requirements: 2.2, 2.3, 2.4_

  - [x] 2.3 Write property test for device name sanitization
    - **Property 1: Device name sanitization and length constraint**
    - **Validates: Requirements 2.2**

  - [x] 2.4 Write property test for note sanitization
    - **Property 2: Note sanitization and length constraint**
    - **Validates: Requirements 2.3**

  - [x] 2.5 Write property test for IP validation
    - **Property 3: IP address validation**
    - **Validates: Requirements 2.4**

  - [x] 2.6 Implement Lambda handler function
    - Parse Lambda Function URL event format (version 2.0)
    - Extract device name from body or headers
    - Extract IP from X-Forwarded-For header
    - Create structured log entry with timestamp, device, IP, note
    - Return HTTP 200 response with "ok" body
    - _Requirements: 2.1, 2.5, 2.6_

  - [x] 2.7 Write property test for structured logging
    - **Property 4: Structured logging format**
    - **Validates: Requirements 2.5**

  - [x] 2.8 Write property test for response format
    - **Property 5: Successful response format**
    - **Validates: Requirements 2.6**

  - [x] 2.9 Write unit tests for Lambda handler
    - Test GET and POST methods
    - Test empty/missing inputs use defaults
    - Test oversized inputs are truncated
    - Test invalid JSON body is handled gracefully
    - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 3. Implement CDK infrastructure stack
  - [x] 3.1 Create CDK stack class
    - Create `cdk/cdk/isp_monitor_stack.py`
    - Define stack with parameters (prefix, alert_email, region)
    - Import required CDK constructs (lambda, logs, cloudwatch, sns, iam)
    - _Requirements: 1.1, 8.2, 8.3_

  - [x] 3.2 Define Lambda function resource
    - Create Lambda function with Python 3.11 runtime
    - Use ARM64 architecture for cost savings
    - Set memory to 128 MB
    - Set timeout to 10 seconds
    - Package code from `lambda/` directory
    - _Requirements: 1.2, 10.1, 10.2_

  - [x] 3.3 Create Lambda Function URL
    - Add Function URL to Lambda
    - Set auth type to NONE (public access)
    - Configure HTTPS only
    - Add Function URL to stack outputs
    - _Requirements: 9.1, 9.2, 9.3, 9.4_

  - [x] 3.4 Create CloudWatch Log Group
    - Define log group for Lambda function
    - Set retention period to 7 days (configurable)
    - Enable encryption at rest
    - _Requirements: 1.3, 10.3_

  - [x] 3.5 Create CloudWatch Metric Filter
    - Define metric filter on log group
    - Filter pattern: `[msg="[heartbeat]", json]`
    - Create custom metric: HeartbeatCount in ISPMonitor namespace
    - Set metric value to 1 for each log entry
    - _Requirements: 3.5_

  - [x] 3.6 Create CloudWatch Alarm
    - Define alarm on HeartbeatCount metric
    - Set evaluation period to 5 minutes
    - Set threshold to less than 1 heartbeat
    - Configure "treat missing data as breaching"
    - Enable alarm actions for ALARM and OK states
    - _Requirements: 3.1, 3.2, 3.3, 10.4_

  - [x] 3.7 Create SNS Topic and email subscription
    - Define SNS topic for alerts
    - Create email subscription with parameter email address
    - Add topic ARN to stack outputs
    - Configure alarm to publish to SNS topic
    - _Requirements: 1.4, 4.1, 4.2, 4.3_

  - [x] 3.8 Configure IAM execution role
    - Create IAM role for Lambda (or use CDK auto-generated)
    - Attach AWSLambdaBasicExecutionRole managed policy
    - Verify CloudWatch Logs permissions
    - Ensure no connection strings in environment variables
    - _Requirements: 1.5, 7.1, 7.2, 7.3, 7.4_

  - [x] 3.9 Add stack outputs
    - Output Lambda function name
    - Output Lambda function URL
    - Output SNS topic ARN
    - Output CloudWatch alarm name
    - _Requirements: 8.4, 9.4_

- [x] 4. Create deployment script
  - [x] 4.1 Create `deploy_aws.sh` script
    - Source environment variables from `.env`
    - Validate required variables (AWS_REGION, ALERT_EMAIL, PREFIX)
    - Check AWS CLI authentication
    - Bootstrap CDK if needed (first deployment)
    - _Requirements: 5.1, 5.5_

  - [x] 4.2 Implement CDK deployment logic
    - Run `cdk synth` to generate CloudFormation template
    - Run `cdk deploy` with auto-approve flag
    - Capture stack outputs (function URL, topic ARN)
    - Handle deployment errors with clear messages
    - _Requirements: 5.2, 5.3, 5.5_

  - [x] 4.3 Add post-deployment verification
    - Test Lambda function URL with curl
    - Verify HTTP 200 response
    - Display function URL and configuration summary
    - Provide instructions for testing alerts
    - _Requirements: 5.4_

  - [x] 4.4 Write integration test for deployment
    - Run deployment script with test parameters
    - Verify all AWS resources are created
    - Verify function URL is accessible
    - Clean up test resources
    - _Requirements: 1.1, 5.2_

- [x] 5. Update heartbeat agent for AWS
  - [x] 5.1 Update agent documentation
    - Update comments in `heartbeat_agent.py` to mention AWS Lambda
    - Update example URLs to Lambda Function URL format
    - Update environment variable documentation
    - _Requirements: 6.1, 6.2_

  - [x] 5.2 Verify agent compatibility
    - Test agent with Lambda Function URL
    - Verify HTTPS and SSL certificate verification
    - Verify zero external dependencies
    - Test both environment variable and CLI argument configuration
    - _Requirements: 6.1, 6.2, 6.3, 6.4_

  - [x] 5.3 Write unit tests for agent configuration
    - Test URL configuration from environment variable
    - Test URL configuration from CLI argument
    - Test HTTPS enforcement
    - Test SSL verification is enabled
    - _Requirements: 6.2, 6.3_

- [x] 6. Create AWS-specific documentation
  - [x] 6.1 Create `README_AWS.md`
    - Document AWS architecture and services
    - Provide deployment instructions
    - Document environment variables
    - Include cost estimation
    - Add troubleshooting section
    - _Requirements: 1.1, 10.5_

  - [x] 6.2 Create `MIGRATION_GUIDE.md`
    - Document migration steps from Azure to AWS
    - Provide pre-migration checklist
    - Document configuration differences
    - Include rollback procedures
    - _Requirements: 1.1_

  - [x] 6.3 Update main `README.md`
    - Add section for AWS deployment option
    - Link to AWS-specific documentation
    - Update architecture diagrams
    - _Requirements: 1.1_

- [x] 7. Create helper scripts
  - [x] 7.1 Create `test_aws_deploy.sh`
    - Validate CDK synthesis without deploying
    - Check for CDK errors and warnings
    - Verify stack outputs are defined
    - _Requirements: 5.2_

  - [x] 7.2 Create `test_aws_alerts.sh`
    - Verify CloudWatch Alarm configuration
    - Check SNS subscription status
    - Display alarm evaluation settings
    - _Requirements: 3.1, 4.2_

  - [x] 7.3 Update `start_heartbeat.sh` and `stop_heartbeat.sh`
    - Ensure scripts work with AWS Lambda URLs
    - Update documentation in scripts
    - _Requirements: 6.1_

- [ ] 8. Checkpoint - Verify end-to-end functionality
  - Deploy infrastructure to AWS test account
  - Configure heartbeat agent with Lambda URL
  - Send test heartbeat and verify CloudWatch Logs
  - Stop heartbeat and verify alarm triggers (wait 6-7 minutes)
  - Verify email notification is received
  - Resume heartbeat and verify alarm resolves
  - Verify resolution email is received
  - Ensure all tests pass, ask the user if questions arise
  - _Requirements: 3.2, 3.3, 4.1, 4.3_

- [x] 9. Integration testing
  - [x] 9.1 Write end-to-end integration test
    - Deploy stack to test account
    - Send heartbeat ping to Lambda
    - Verify CloudWatch Logs contain entry
    - Verify Lambda returns HTTP 200
    - _Requirements: 2.1, 2.5, 2.6_

  - [-] 9.2 Write alarm behavior test
    - Stop sending pings for 6+ minutes
    - Verify CloudWatch Alarm enters ALARM state
    - Resume pings
    - Verify CloudWatch Alarm returns to OK state
    - _Requirements: 3.2, 3.3_

- [ ] 10. Final cleanup and optimization
  - [ ] 10.1 Review and optimize Lambda memory settings
    - Test Lambda with different memory allocations
    - Verify 128 MB is sufficient
    - Document memory usage in README
    - _Requirements: 10.1_

  - [ ] 10.2 Review and optimize CloudWatch costs
    - Verify log retention is set appropriately
    - Consider using Logs Insights instead of metric filters
    - Document cost optimization tips
    - _Requirements: 10.3, 10.5_

  - [ ] 10.3 Security review
    - Verify IAM roles use least-privilege permissions
    - Verify no secrets in environment variables
    - Verify HTTPS-only configuration
    - Verify input validation and sanitization
    - _Requirements: 1.5, 7.2, 9.2_

  - [ ] 10.4 Update project documentation
    - Update main README with AWS option
    - Ensure all scripts have usage documentation
    - Add architecture diagrams for AWS
    - Document differences between Azure and AWS implementations
    - _Requirements: 1.1_
