# AWS Migration Design Document

## Overview

This design document outlines the migration of the Azure ISP Monitor to AWS equivalent services. The system will maintain the same core functionality: a heartbeat agent sends periodic pings to a serverless endpoint, and alerts are triggered when pings are missing. The migration replaces Azure-specific services with AWS equivalents while preserving the architecture and user experience.

### Service Mapping

| Azure Service | AWS Equivalent | Purpose |
|--------------|----------------|---------|
| Azure Functions | AWS Lambda + Function URLs | Serverless HTTP endpoint |
| Application Insights | CloudWatch Logs | Structured logging |
| Azure Monitor Alerts | CloudWatch Alarms | Missing heartbeat detection |
| Action Groups | SNS Topics | Email notifications |
| Bicep | CloudFormation/CDK/Terraform | Infrastructure as Code |
| Managed Identity | IAM Execution Roles | Service authentication |
| Storage Account | (Not needed) | Lambda doesn't require external storage |

## Architecture

### High-Level Architecture

```
┌─────────────────┐
│  Monitored      │
│  Device         │
│                 │
│  heartbeat_     │
│  agent.py       │
└────────┬────────┘
         │ HTTPS POST
         │ (every 60s)
         ▼
┌─────────────────────────┐
│  AWS Lambda             │
│  (Python 3.11)          │
│                         │
│  - Validate input       │
│  - Sanitize data        │
│  - Log to CloudWatch    │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  CloudWatch Logs        │
│                         │
│  - Structured JSON logs │
│  - Metric filters       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  CloudWatch Alarm       │
│                         │
│  - 5-min evaluation     │
│  - Detect missing pings │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  SNS Topic              │
│                         │
│  - Email subscription   │
│  - Alert notifications  │
└─────────────────────────┘
```

### Request Flow

1. **Heartbeat Agent** sends HTTPS POST to Lambda Function URL
2. **Lambda Function** validates input, extracts metadata, logs to CloudWatch
3. **CloudWatch Logs** stores structured JSON with device, IP, timestamp
4. **Metric Filter** (optional) creates custom metric from log entries
5. **CloudWatch Alarm** evaluates metric/logs every 5 minutes
6. **SNS Topic** sends email when alarm state changes (ALARM/OK)

## Components and Interfaces

### 1. Lambda Function (Ping Handler)

**Runtime**: Python 3.11 on ARM64 architecture  
**Memory**: 128 MB (minimal for cost optimization)  
**Timeout**: 10 seconds  
**Trigger**: Lambda Function URL (public, no auth)

**Input Interface**:
```json
{
  "device": "string (max 100 chars)",
  "note": "string (max 500 chars, optional)"
}
```

**Headers**:
- `X-Forwarded-For`: Client IP address (provided by Lambda/ALB)
- `X-Device`: Alternative device identifier (fallback)

**Output Interface**:
```
HTTP 200 OK
Content-Type: text/plain
Body: "ok"
```

**CloudWatch Log Format**:
```json
{
  "ts": 1702345678,
  "device": "home-server",
  "ip": "203.0.113.42",
  "note": "daemon ping #1702345678"
}
```

### 2. Lambda Function URL

**Configuration**:
- Auth Type: `NONE` (public access for heartbeat pings)
- CORS: Disabled (not needed for direct agent calls)
- Invoke Mode: `BUFFERED` (standard request/response)

**URL Format**: `https://<function-id>.lambda-url.<region>.on.aws/`

### 3. CloudWatch Logs

**Log Group**: `/aws/lambda/isp-monitor-ping`  
**Retention**: 7 days (configurable, balance cost vs. history)  
**Metric Filter** (Option A):
- Filter Pattern: `[msg="[heartbeat]", json]`
- Metric Name: `HeartbeatCount`
- Metric Namespace: `ISPMonitor`
- Metric Value: `1`

### 4. CloudWatch Alarm

**Alarm Name**: `{prefix}-heartbeat-missing`  
**Metric**: Custom metric `HeartbeatCount` OR Logs Insights query  
**Evaluation Period**: 1 period of 5 minutes  
**Threshold**: Less than 1 heartbeat in 5 minutes  
**Datapoints to Alarm**: 1 out of 1  
**Treat Missing Data**: `breaching` (missing data = alarm)  
**Actions**:
- ALARM state: Publish to SNS topic
- OK state: Publish to SNS topic (auto-resolution)

**Alternative: Logs Insights Query Alarm**:
```
fields @timestamp, @message
| filter @message like /\[heartbeat\]/
| stats count() as heartbeat_count
```
- Threshold: `heartbeat_count < 1`

### 5. SNS Topic

**Topic Name**: `{prefix}-isp-monitor-alerts`  
**Subscription**:
- Protocol: `email`
- Endpoint: User-provided email address
- Confirmation: Required (AWS sends confirmation email)

**Message Format**:
- Subject: Auto-generated by CloudWatch
- Body: Alarm details, threshold, current state

### 6. IAM Execution Role

**Role Name**: `{prefix}-lambda-execution-role`  
**Managed Policies**:
- `AWSLambdaBasicExecutionRole` (CloudWatch Logs write access)

**Inline Policy** (if needed):
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:log-group:/aws/lambda/isp-monitor-ping:*"
    }
  ]
}
```

### 7. Heartbeat Agent

**Changes Required**:
- Update default URL to Lambda Function URL format
- No other changes needed (HTTP POST with JSON body remains the same)

**Configuration**:
```bash
export HEARTBEAT_URL="https://<function-id>.lambda-url.<region>.on.aws/"
export HEARTBEAT_DEVICE="home-server"
export HEARTBEAT_INTERVAL="60"
```

## Data Models

### Heartbeat Log Entry

```python
{
    "ts": int,          # Unix timestamp
    "device": str,      # Device identifier (sanitized, max 100 chars)
    "ip": str,          # Client IP address (validated)
    "note": str         # Optional note (sanitized, max 500 chars)
}
```

### Lambda Event (Function URL)

```python
{
    "version": "2.0",
    "routeKey": "$default",
    "rawPath": "/",
    "headers": {
        "x-forwarded-for": "203.0.113.42",
        "content-type": "application/json",
        ...
    },
    "body": "{\"device\":\"home-server\",\"note\":\"test\"}",
    "isBase64Encoded": false,
    ...
}
```

### Lambda Response (Function URL)

```python
{
    "statusCode": 200,
    "headers": {
        "Content-Type": "text/plain"
    },
    "body": "ok"
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

