# Requirements Document

## Introduction

This document specifies the requirements for migrating the Azure ISP Monitor system to AWS equivalent services. The system monitors internet connectivity by receiving periodic heartbeat pings from a client agent and sending email alerts when connectivity is lost. The migration must maintain functional parity with the Azure implementation while leveraging AWS-native services.

## Glossary

- **Heartbeat Agent**: A Python script running on a monitored device that sends periodic HTTP pings to verify internet connectivity
- **Function Endpoint**: A serverless HTTP endpoint that receives and logs heartbeat pings (Azure Functions → AWS Lambda)
- **Monitoring Service**: A cloud service that detects missing heartbeats and triggers alerts (Azure Monitor → CloudWatch)
- **Alert System**: A notification system that sends emails when connectivity issues are detected (Azure Action Groups → SNS)
- **Infrastructure as Code (IaC)**: Declarative configuration files that define cloud resources (Bicep → CloudFormation/CDK/Terraform)
- **Managed Identity**: Cloud-native authentication mechanism for service-to-service communication (Azure Managed Identity → IAM Roles)
- **Application Insights**: Logging and monitoring service (Azure Application Insights → CloudWatch Logs)

## Requirements

### Requirement 1

**User Story:** As a system administrator, I want to deploy the ISP monitoring infrastructure on AWS, so that I can monitor internet connectivity using AWS services.

#### Acceptance Criteria

1. WHEN deploying infrastructure THEN the system SHALL create all required AWS resources using Infrastructure as Code
2. WHEN resources are created THEN the system SHALL use AWS Lambda for the serverless function endpoint
3. WHEN resources are created THEN the system SHALL use CloudWatch for logging and monitoring
4. WHEN resources are created THEN the system SHALL use SNS for email notifications
5. WHEN resources are created THEN the system SHALL use IAM roles instead of connection strings for service authentication

### Requirement 2

**User Story:** As a developer, I want the Lambda function to receive and validate heartbeat pings, so that connectivity events are properly logged.

#### Acceptance Criteria

1. WHEN the Lambda function receives an HTTP request THEN the system SHALL accept both GET and POST methods
2. WHEN processing a request THEN the system SHALL validate and sanitize the device name to a maximum of 100 characters
3. WHEN processing a request THEN the system SHALL validate and sanitize optional notes to a maximum of 500 characters
4. WHEN processing a request THEN the system SHALL extract and validate the client IP address from request headers
5. WHEN processing a request THEN the system SHALL log structured JSON data to CloudWatch Logs
6. WHEN processing completes successfully THEN the system SHALL return HTTP 200 with "ok" response body

### Requirement 3

**User Story:** As a system administrator, I want CloudWatch to detect missing heartbeats, so that I am alerted when internet connectivity is lost.

#### Acceptance Criteria

1. WHEN evaluating metrics THEN the system SHALL check for heartbeat pings within a 5-minute window
2. WHEN no heartbeat pings are detected within the window THEN the system SHALL trigger an alert
3. WHEN heartbeat pings resume THEN the system SHALL automatically resolve the alert
4. WHEN an alert is triggered THEN the system SHALL send notifications every 5 minutes until resolved
5. WHEN configuring the alarm THEN the system SHALL use CloudWatch Metrics or Logs Insights queries

### Requirement 4

**User Story:** As a user, I want to receive email notifications when connectivity is lost, so that I can take corrective action.

#### Acceptance Criteria

1. WHEN an alert is triggered THEN the system SHALL send an email notification via SNS
2. WHEN configuring notifications THEN the system SHALL accept an email address as a parameter
3. WHEN an alert resolves THEN the system SHALL send a resolution notification email
4. WHEN the SNS topic is created THEN the system SHALL automatically create and confirm the email subscription

### Requirement 5

**User Story:** As a developer, I want to deploy the infrastructure using a single command, so that deployment is automated and repeatable.

#### Acceptance Criteria

1. WHEN running the deployment script THEN the system SHALL read configuration from environment variables
2. WHEN deploying THEN the system SHALL create or update all AWS resources idempotently
3. WHEN deployment completes THEN the system SHALL output the Lambda function URL
4. WHEN deployment completes THEN the system SHALL verify the function endpoint is responding
5. WHEN deployment fails THEN the system SHALL provide clear error messages

### Requirement 6

**User Story:** As a developer, I want the heartbeat agent to work with AWS Lambda, so that the agent requires minimal changes.

#### Acceptance Criteria

1. WHEN the agent sends a ping THEN the system SHALL use the Lambda function URL as the endpoint
2. WHEN the agent is configured THEN the system SHALL accept the endpoint URL via environment variable or command-line argument
3. WHEN the agent sends requests THEN the system SHALL use HTTPS with SSL certificate verification
4. WHEN the agent operates THEN the system SHALL maintain zero external dependencies beyond Python standard library

### Requirement 7

**User Story:** As a system administrator, I want to use AWS-native authentication, so that credentials are managed securely without connection strings.

#### Acceptance Criteria

1. WHEN Lambda accesses AWS services THEN the system SHALL use IAM execution roles
2. WHEN configuring permissions THEN the system SHALL grant least-privilege access to required services
3. WHEN Lambda writes logs THEN the system SHALL use IAM permissions for CloudWatch Logs access
4. WHEN Lambda is invoked THEN the system SHALL not require API keys or connection strings in environment variables

### Requirement 8

**User Story:** As a developer, I want to choose an appropriate IaC tool for AWS, so that infrastructure is maintainable and follows AWS best practices.

#### Acceptance Criteria

1. WHEN selecting an IaC tool THEN the system SHALL support either CloudFormation, AWS CDK, or Terraform
2. WHEN defining resources THEN the system SHALL use declarative configuration
3. WHEN deploying THEN the system SHALL support parameterization for environment-specific values
4. WHEN resources are created THEN the system SHALL output key values like function URL and topic ARN

### Requirement 9

**User Story:** As a developer, I want the Lambda function to use API Gateway or Function URLs, so that it can receive HTTP requests from the internet.

#### Acceptance Criteria

1. WHEN exposing the Lambda function THEN the system SHALL use either Lambda Function URLs or API Gateway
2. WHEN the endpoint is created THEN the system SHALL support HTTPS only
3. WHEN the endpoint is created THEN the system SHALL allow unauthenticated access for heartbeat pings
4. WHEN the endpoint is configured THEN the system SHALL return the public URL for agent configuration

### Requirement 10

**User Story:** As a system administrator, I want cost-effective AWS resource configuration, so that monthly costs remain low (comparable to Azure's $2-10/month).

#### Acceptance Criteria

1. WHEN configuring Lambda THEN the system SHALL use minimal memory allocation (128-256 MB)
2. WHEN configuring Lambda THEN the system SHALL use ARM64 architecture for cost savings
3. WHEN configuring CloudWatch THEN the system SHALL use appropriate log retention periods
4. WHEN configuring alarms THEN the system SHALL minimize metric evaluation frequency while maintaining 5-minute detection
5. WHEN estimating costs THEN the system SHALL target AWS Free Tier eligibility where possible
