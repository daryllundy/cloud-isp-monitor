# AWS Migration Design Document

## Overview

This design document outlines the migration of the Azure ISP Monitor to AWS equivalent services. The system will maintain the same core functionality: a heartbeat agent sends periodic pings to a serverless endpoint, and alerts are triggered when pings are missing. The migration replaces Azure-specific services with AWS equivalents while preserving the architecture and user experience.

### Service Mapping

| Azure Service | AWS Equivalent | Purpose |
|--------------|----------------|---------|
| Azure Functions | AWS Lambda + Function URLs | Serverless HTTP endpoint |
| Application Insights | CloudWatch Logs | Structured logging |
| Azure Monitor Alerts | CloudWatch Alarms | Missing heartbeat detection |
| Action Groups | SNS Topics | Email notifications |
| Bicep | CloudFormation/CDK/Terraform | Infrastructure as Code |
| Managed Identity | IAM Execution Roles | Service authentication |
| Storage Account | (Not needed) | Lambda doesn't require external storage |

## Architecture

### High-Level Architecture

```
┌─────────────────┐
│  Monitored      │
│  Device         │
│                 │
│  heartbeat_     │
│  agent.py       │
└────────┬────────┘
         │ HTTPS POST
         │ (every 60s)
         ▼
┌─────────────────────────┐
│  AWS Lambda             │
│  (Python 3.11)          │
│                         │
│  - Validate input       │
│  - Sanitize data        │
│  - Log to CloudWatch    │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  CloudWatch Logs        │
│                         │
│  - Structured JSON logs │
│  - Metric filters       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  CloudWatch Alarm       │
│                         │
│  - 5-min evaluation     │
│  - Detect missing pings │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  SNS Topic              │
│                         │
│  - Email subscription   │
│  - Alert notifications  │
└─────────────────────────┘
```

### Request Flow

1. **Heartbeat Agent** sends HTTPS POST to Lambda Function URL
2. **Lambda Function** validates input, extracts metadata, logs to CloudWatch
3. **CloudWatch Logs** stores structured JSON with device, IP, timestamp
4. **Metric Filter** (optional) creates custom metric from log entries
5. **CloudWatch Alarm** evaluates metric/logs every 5 minutes
6. **SNS Topic** sends email when alarm state changes (ALARM/OK)

## Components and Interfaces

### 1. Lambda Function (Ping Handler)

**Runtime**: Python 3.11 on ARM64 architecture  
**Memory**: 128 MB (minimal for cost optimization)  
**Timeout**: 10 seconds  
**Trigger**: Lambda Function URL (public, no auth)

**Input Interface**:
```json
{
  "device": "string (max 100 chars)",
  "note": "string (max 500 chars, optional)"
}
```

**Headers**:
- `X-Forwarded-For`: Client IP address (provided by Lambda/ALB)
- `X-Device`: Alternative device identifier (fallback)

**Output Interface**:
```
HTTP 200 OK
Content-Type: text/plain
Body: "ok"
```

**CloudWatch Log Format**:
```json
{
  "ts": 1702345678,
  "device": "home-server",
  "ip": "203.0.113.42",
  "note": "daemon ping #1702345678"
}
```

### 2. Lambda Function URL

**Configuration**:
- Auth Type: `NONE` (public access for heartbeat pings)
- CORS: Disabled (not needed for direct agent calls)
- Invoke Mode: `BUFFERED` (standard request/response)

**URL Format**: `https://<function-id>.lambda-url.<region>.on.aws/`

### 3. CloudWatch Logs

**Log Group**: `/aws/lambda/isp-monitor-ping`  
**Retention**: 7 days (configurable, balance cost vs. history)  
**Metric Filter** (Option A):
- Filter Pattern: `[msg="[heartbeat]", json]`
- Metric Name: `HeartbeatCount`
- Metric Namespace: `ISPMonitor`
- Metric Value: `1`

### 4. CloudWatch Alarm

**Alarm Name**: `{prefix}-heartbeat-missing`  
**Metric**: Custom metric `HeartbeatCount` OR Logs Insights query  
**Evaluation Period**: 1 period of 5 minutes  
**Threshold**: Less than 1 heartbeat in 5 minutes  
**Datapoints to Alarm**: 1 out of 1  
**Treat Missing Data**: `breaching` (missing data = alarm)  
**Actions**:
- ALARM state: Publish to SNS topic
- OK state: Publish to SNS topic (auto-resolution)

**Alternative: Logs Insights Query Alarm**:
```
fields @timestamp, @message
| filter @message like /\[heartbeat\]/
| stats count() as heartbeat_count
```
- Threshold: `heartbeat_count < 1`

### 5. SNS Topic

**Topic Name**: `{prefix}-isp-monitor-alerts`  
**Subscription**:
- Protocol: `email`
- Endpoint: User-provided email address
- Confirmation: Required (AWS sends confirmation email)

**Message Format**:
- Subject: Auto-generated by CloudWatch
- Body: Alarm details, threshold, current state

### 6. IAM Execution Role

**Role Name**: `{prefix}-lambda-execution-role`  
**Managed Policies**:
- `AWSLambdaBasicExecutionRole` (CloudWatch Logs write access)

**Inline Policy** (if needed):
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:log-group:/aws/lambda/isp-monitor-ping:*"
    }
  ]
}
```

### 7. Heartbeat Agent

**Changes Required**:
- Update default URL to Lambda Function URL format
- No other changes needed (HTTP POST with JSON body remains the same)

**Configuration**:
```bash
export HEARTBEAT_URL="https://<function-id>.lambda-url.<region>.on.aws/"
export HEARTBEAT_DEVICE="home-server"
export HEARTBEAT_INTERVAL="60"
```

## Data Models

### Heartbeat Log Entry

```python
{
    "ts": int,          # Unix timestamp
    "device": str,      # Device identifier (sanitized, max 100 chars)
    "ip": str,          # Client IP address (validated)
    "note": str         # Optional note (sanitized, max 500 chars)
}
```

### Lambda Event (Function URL)

```python
{
    "version": "2.0",
    "routeKey": "$default",
    "rawPath": "/",
    "headers": {
        "x-forwarded-for": "203.0.113.42",
        "content-type": "application/json",
        ...
    },
    "body": "{\"device\":\"home-server\",\"note\":\"test\"}",
    "isBase64Encoded": false,
    ...
}
```

### Lambda Response (Function URL)

```python
{
    "statusCode": 200,
    "headers": {
        "Content-Type": "text/plain"
    },
    "body": "ok"
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*


### Property Reflection

After reviewing the prework analysis, most acceptance criteria are configuration checks or integration tests rather than universal properties. The key properties that apply across multiple inputs are related to input validation and sanitization in the Lambda function. These are the core correctness properties that should hold for all requests.

### Core Properties

Property 1: Device name sanitization and length constraint
*For any* input string provided as a device name, the sanitized output should contain no control characters and should not exceed 100 characters in length
**Validates: Requirements 2.2**

Property 2: Note sanitization and length constraint
*For any* input string provided as a note, the sanitized output should contain no control characters and should not exceed 500 characters in length
**Validates: Requirements 2.3**

Property 3: IP address validation
*For any* string provided in the X-Forwarded-For header, the extracted IP should either be a valid IPv4 address, a valid IPv6 address, or the string "unknown"
**Validates: Requirements 2.4**

Property 4: Structured logging format
*For any* valid request, the logged output should be valid JSON containing the required fields: ts, device, ip, and note
**Validates: Requirements 2.5**

Property 5: Successful response format
*For any* valid request, the Lambda function should return HTTP 200 status code with body "ok" and Content-Type "text/plain"
**Validates: Requirements 2.6**

### Configuration Properties (Examples)

The following are important verification points but are tested as specific examples rather than universal properties:

- Infrastructure deployment creates all required AWS resources (Lambda, CloudWatch, SNS, IAM)
- Lambda function accepts both GET and POST HTTP methods
- CloudWatch Alarm is configured with 5-minute evaluation window
- SNS topic sends notifications on alarm state changes
- IAM roles are used instead of connection strings
- Lambda uses ARM64 architecture and minimal memory (128-256 MB)
- Function URL or API Gateway is configured for HTTPS-only access
- Deployment script outputs Lambda function URL

## Error Handling

### Lambda Function Errors

**Invalid JSON Body**:
- Behavior: Treat as empty body, use defaults
- Response: HTTP 200 (graceful degradation)
- Logging: Log with default values

**Missing Device Name**:
- Behavior: Use "unknown" as default
- Response: HTTP 200
- Logging: Log with device="unknown"

**Oversized Input**:
- Behavior: Truncate to maximum length
- Response: HTTP 200
- Logging: Log truncated values

**Invalid IP Format**:
- Behavior: Use "unknown" as IP value
- Response: HTTP 200
- Logging: Log with ip="unknown"

**CloudWatch Logging Failure**:
- Behavior: Lambda execution fails, retry automatically
- Response: HTTP 500 (Lambda error)
- Monitoring: CloudWatch Errors metric increases

### Deployment Errors

**Missing Environment Variables**:
- Behavior: Script exits with error message
- Exit Code: 1
- Message: "Error: VARIABLE_NAME must be set"

**AWS CLI Not Authenticated**:
- Behavior: Script exits with AWS error
- Exit Code: 1
- Message: AWS CLI error output

**Resource Creation Failure**:
- Behavior: CloudFormation/CDK rollback
- Exit Code: 1
- Message: Stack creation/update error details

**Function URL Not Responding**:
- Behavior: Warning message, deployment continues
- Exit Code: 0
- Message: "⚠ Function returned HTTP XXX. Check logs..."

### Agent Errors

**Network Connectivity Loss**:
- Behavior: Log error, continue retrying
- Exit Code: N/A (daemon continues)
- Tracking: Increment consecutive_failures counter

**Invalid URL Configuration**:
- Behavior: Exit immediately with error
- Exit Code: 1
- Message: "Error: URL must start with http:// or https://"

**SSL Certificate Verification Failure**:
- Behavior: Log error, continue retrying
- Exit Code: N/A (daemon continues)
- Message: "✗ URL Error: [SSL: CERTIFICATE_VERIFY_FAILED]"

**HTTP 4xx/5xx Responses**:
- Behavior: Log error, continue retrying
- Exit Code: N/A (daemon continues)
- Message: "✗ HTTP Error XXX: reason"

## Testing Strategy

### Unit Testing

The Lambda function should have unit tests covering:

1. **Input Validation**:
   - Valid device names and notes
   - Empty/null inputs use defaults
   - Oversized inputs are truncated
   - Control characters are removed

2. **IP Extraction**:
   - Valid IPv4 addresses
   - Valid IPv6 addresses
   - Multiple IPs in X-Forwarded-For (take first)
   - Missing or invalid IPs return "unknown"

3. **Response Format**:
   - HTTP 200 status code
   - "ok" response body
   - Correct Content-Type header

4. **Logging Format**:
   - Output is valid JSON
   - Contains all required fields
   - Timestamp is Unix epoch integer

### Property-Based Testing

**PBT Library**: Use `hypothesis` for Python property-based testing

**Configuration**: Each property test should run a minimum of 100 iterations

**Test Tagging**: Each property-based test must include a comment with the format:
`# Feature: aws-migration, Property {number}: {property_text}`

**Properties to Test**:

1. **Property 1: Device name sanitization**
   - Generate: Random strings (0-200 chars, including control chars, unicode)
   - Verify: Output ≤ 100 chars, no control characters (\\x00-\\x1f, \\x7f-\\x9f)
   - Tag: `# Feature: aws-migration, Property 1: Device name sanitization and length constraint`

2. **Property 2: Note sanitization**
   - Generate: Random strings (0-1000 chars, including control chars, unicode)
   - Verify: Output ≤ 500 chars, no control characters
   - Tag: `# Feature: aws-migration, Property 2: Note sanitization and length constraint`

3. **Property 3: IP validation**
   - Generate: Random strings, valid IPv4, valid IPv6, malformed IPs
   - Verify: Output is valid IPv4, valid IPv6, or "unknown"
   - Tag: `# Feature: aws-migration, Property 3: IP address validation`

4. **Property 4: Structured logging**
   - Generate: Random valid requests
   - Verify: Log output is valid JSON with keys: ts, device, ip, note
   - Tag: `# Feature: aws-migration, Property 4: Structured logging format`

5. **Property 5: Response format**
   - Generate: Random valid requests
   - Verify: Status=200, body="ok", Content-Type="text/plain"
   - Tag: `# Feature: aws-migration, Property 5: Successful response format`

### Integration Testing

Integration tests should verify:

1. **Deployment**:
   - Run deployment script with test parameters
   - Verify all AWS resources are created
   - Verify function URL is accessible

2. **End-to-End Flow**:
   - Send heartbeat ping to Lambda function URL
   - Verify CloudWatch Logs contain the log entry
   - Verify Lambda returns HTTP 200

3. **Alarm Behavior**:
   - Stop sending pings for 6+ minutes
   - Verify CloudWatch Alarm enters ALARM state
   - Resume pings
   - Verify CloudWatch Alarm returns to OK state

4. **SNS Notifications**:
   - Trigger alarm manually or via missing pings
   - Verify SNS publishes message to topic
   - (Manual) Verify email is received

### Testing Approach

- **Implementation-first development**: Implement the Lambda function and infrastructure before writing comprehensive tests
- **Property tests for core logic**: Use PBT for input validation and sanitization functions
- **Unit tests for specific cases**: Test edge cases like empty inputs, missing headers
- **Integration tests for deployment**: Verify the full deployment and end-to-end flow
- **Manual testing for email**: Confirm email notifications are received (AWS requires manual SNS subscription confirmation)

## Infrastructure as Code Options

### Option 1: AWS CloudFormation (YAML)

**Pros**:
- Native AWS service, no additional tools
- Direct equivalent to Azure Bicep
- Supports all AWS resources
- Free to use

**Cons**:
- Verbose YAML syntax
- Less developer-friendly than CDK
- No type checking

**Recommendation**: Good choice for simple deployments, direct Bicep equivalent

### Option 2: AWS CDK (TypeScript/Python)

**Pros**:
- Programmatic infrastructure definition
- Type checking and IDE support
- Reusable constructs
- Generates CloudFormation templates

**Cons**:
- Requires Node.js/npm (TypeScript) or Python dependencies
- Additional abstraction layer
- Steeper learning curve

**Recommendation**: Best for complex deployments, preferred for maintainability

### Option 3: Terraform (HCL)

**Pros**:
- Cloud-agnostic (works with Azure and AWS)
- Mature ecosystem
- Good for multi-cloud scenarios

**Cons**:
- Third-party tool (not AWS-native)
- Requires Terraform CLI installation
- State management complexity

**Recommendation**: Good for multi-cloud or existing Terraform users

### Selected Approach: AWS CDK (Python)

**Rationale**:
- Matches existing Python codebase
- Type checking prevents configuration errors
- Easier to maintain than raw CloudFormation
- Generates CloudFormation for AWS-native deployment
- Better developer experience than YAML

## Deployment Architecture

### Deployment Script Flow

```
1. Load environment variables from .env
2. Validate required variables (REGION, ALERT_EMAIL, PREFIX)
3. Bootstrap CDK (if first deployment)
4. Synthesize CloudFormation template
5. Deploy stack (create/update resources)
6. Wait for stack completion
7. Retrieve outputs (Function URL, SNS Topic ARN)
8. Test function endpoint
9. Display configuration summary
```

### Environment Variables

```bash
# Required
AWS_REGION=us-east-1
ALERT_EMAIL=user@example.com
PREFIX=isp-monitor

# Optional
LOG_RETENTION_DAYS=7
LAMBDA_MEMORY_MB=128
ALARM_EVALUATION_MINUTES=5
```

### CDK Stack Structure

```python
class ISPMonitorStack(Stack):
    def __init__(self, scope, id, **kwargs):
        # 1. Lambda Function
        # 2. Lambda Function URL
        # 3. CloudWatch Log Group
        # 4. CloudWatch Metric Filter (optional)
        # 5. CloudWatch Alarm
        # 6. SNS Topic
        # 7. SNS Email Subscription
        # 8. IAM Execution Role (auto-created by CDK)
```

## Migration Checklist

### Pre-Migration

- [ ] Review current Azure deployment and configuration
- [ ] Document current alert email and device names
- [ ] Export any historical Application Insights data (if needed)
- [ ] Install AWS CLI and configure credentials
- [ ] Install AWS CDK CLI (`npm install -g aws-cdk`)

### Migration Steps

- [ ] Create `.env` file with AWS configuration
- [ ] Deploy AWS infrastructure using CDK
- [ ] Verify Lambda function is accessible
- [ ] Update heartbeat agent configuration with new URL
- [ ] Test heartbeat agent connectivity
- [ ] Verify CloudWatch Logs are receiving entries
- [ ] Test alarm by stopping heartbeat for 6+ minutes
- [ ] Confirm email notifications are received
- [ ] Confirm alarm auto-resolution when heartbeat resumes

### Post-Migration

- [ ] Monitor AWS costs for first billing cycle
- [ ] Update documentation with AWS-specific instructions
- [ ] Decommission Azure resources (after verification period)
- [ ] Update any external references to old Azure URLs

## Cost Estimation

### AWS Free Tier (First 12 Months)

- **Lambda**: 1M requests/month, 400,000 GB-seconds compute
- **CloudWatch Logs**: 5 GB ingestion, 5 GB storage
- **CloudWatch Alarms**: 10 alarms
- **SNS**: 1,000 email notifications/month

### Expected Usage (60-second heartbeat interval)

- **Lambda Invocations**: ~43,200/month (1 per minute)
- **Lambda Compute**: ~5,400 GB-seconds/month (128 MB × 1s × 43,200)
- **CloudWatch Logs**: ~50 MB/month (structured JSON logs)
- **CloudWatch Alarms**: 1 alarm
- **SNS Emails**: ~10-20/month (assuming occasional outages)

### Estimated Monthly Cost (After Free Tier)

- **Lambda**: $0.00 (well within free tier)
- **CloudWatch Logs**: $0.00 (well within free tier)
- **CloudWatch Alarms**: $0.10 (first 10 free, then $0.10/alarm)
- **SNS**: $0.00 (well within free tier)

**Total**: ~$0.10-$0.50/month (comparable to Azure's $2-10/month)

### Cost Optimization Tips

1. Use ARM64 architecture (20% cost savings on Lambda)
2. Set appropriate log retention (7 days vs. indefinite)
3. Use minimal Lambda memory (128 MB sufficient)
4. Consider CloudWatch Logs Insights instead of custom metrics (no metric costs)
5. Use Lambda Function URLs instead of API Gateway (no API Gateway costs)

## Security Considerations

### Lambda Function

- **HTTPS Only**: Function URL enforces HTTPS
- **Input Validation**: All inputs sanitized and validated
- **No Secrets**: No API keys or connection strings in environment
- **IAM Execution Role**: Least-privilege permissions
- **Public Access**: Required for heartbeat agent (consider IP allowlist if needed)

### CloudWatch Logs

- **Encryption**: Encrypted at rest by default
- **Retention**: Limited retention period reduces data exposure
- **Access Control**: IAM policies control log access

### SNS Topic

- **Email Confirmation**: AWS requires manual subscription confirmation
- **Encryption**: Consider enabling encryption at rest for sensitive alerts
- **Access Control**: IAM policies control publish permissions

### Deployment

- **AWS Credentials**: Use IAM user with minimal permissions or AWS SSO
- **Environment Variables**: Store in `.env` file (gitignored)
- **CDK Bootstrap**: One-time setup per account/region

### Agent

- **SSL Verification**: Enabled by default (do not disable)
- **No Credentials**: Agent doesn't store AWS credentials
- **HTTPS Only**: Enforced by Lambda Function URL

## Monitoring and Observability

### CloudWatch Dashboards (Optional)

Create a dashboard to visualize:
- Heartbeat count over time
- Lambda invocation count
- Lambda error rate
- Alarm state history

### CloudWatch Insights Queries

**Recent Heartbeats**:
```
fields @timestamp, device, ip, note
| filter @message like /\[heartbeat\]/
| sort @timestamp desc
| limit 20
```

**Heartbeat Count by Device**:
```
fields @timestamp, device
| filter @message like /\[heartbeat\]/
| stats count() by device
```

**Missing Heartbeats**:
```
fields @timestamp
| filter @message like /\[heartbeat\]/
| stats count() as heartbeat_count by bin(5m)
| filter heartbeat_count < 1
```

### Alarm History

View alarm state changes:
```bash
aws cloudwatch describe-alarm-history \
  --alarm-name isp-monitor-heartbeat-missing \
  --max-records 10
```

### Lambda Metrics

Key metrics to monitor:
- `Invocations`: Total requests
- `Errors`: Failed invocations
- `Duration`: Execution time
- `Throttles`: Rate limit hits (should be 0)

## Maintenance and Operations

### Updating Lambda Code

```bash
# Option 1: CDK deployment (recommended)
cdk deploy

# Option 2: Direct update (for quick fixes)
cd lambda
zip -r function.zip .
aws lambda update-function-code \
  --function-name isp-monitor-ping \
  --zip-file fileb://function.zip
```

### Updating Alarm Configuration

Modify CDK stack and redeploy:
```python
alarm = cloudwatch.Alarm(
    self, "HeartbeatAlarm",
    evaluation_periods=1,
    threshold=1,
    # Update configuration here
)
```

### Viewing Logs

```bash
# Tail logs in real-time
aws logs tail /aws/lambda/isp-monitor-ping --follow

# Query recent logs
aws logs filter-log-events \
  --log-group-name /aws/lambda/isp-monitor-ping \
  --start-time $(date -u -d '1 hour ago' +%s)000
```

### Testing Alarm

```bash
# Stop heartbeat agent
./stop_heartbeat.sh

# Wait 6-7 minutes

# Check alarm state
aws cloudwatch describe-alarms \
  --alarm-names isp-monitor-heartbeat-missing \
  --query 'MetricAlarms[0].StateValue'

# Resume heartbeat
./start_heartbeat.sh
```

### Troubleshooting

**No logs appearing in CloudWatch**:
- Check Lambda execution role has CloudWatch Logs permissions
- Verify Lambda function is being invoked (check Invocations metric)
- Check for Lambda errors (check Errors metric)

**Alarm not triggering**:
- Verify alarm is enabled
- Check alarm configuration (threshold, evaluation period)
- Verify metric filter is creating metrics (if using custom metrics)
- Check "Treat missing data" setting (should be "breaching")

**Email notifications not received**:
- Verify SNS subscription is confirmed (check email for confirmation link)
- Check spam folder
- Verify alarm actions include SNS topic ARN
- Check SNS topic delivery logs

**High costs**:
- Review CloudWatch Logs retention period
- Check for unexpected Lambda invocations
- Verify no custom metrics are being created unnecessarily
- Consider using Logs Insights queries instead of metric filters
